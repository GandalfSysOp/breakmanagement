<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Break Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background:#f5f7fb;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}

.card {
  max-width:800px;
  margin:40px auto;
  border-radius:16px;
  border:none;
  box-shadow:0 12px 28px rgba(0,0,0,0.08);
}

.clock {
  font-size:2.5rem;
  font-weight:700;
  letter-spacing:1px;
}

.sub { color:#6c757d; }

#timer {
  display:none;
  font-size:1.3rem;
  font-weight:600;
}

.badge-time {
  background:#eef2ff;
  color:#3730a3;
}

.table td, .table th {
  vertical-align:middle;
  white-space:nowrap;
}
</style>
</head>
<body>

<div class="card p-4 text-center">

  <h4 id="userName"></h4>

  <div class="sub">New Delhi (IST)</div>
  <div id="digitalClock" class="clock">--:--:--</div>

  <div id="timer" class="text-primary mt-1">00:00:00.000</div>

  <div class="mt-3 d-flex justify-content-center gap-3">
    <button id="outBtn" class="btn btn-outline-danger btn-lg px-5">Out</button>
    <button id="inBtn" class="btn btn-outline-success btn-lg px-5 d-none">In</button>
  </div>

  <div id="status" class="mt-2 small text-muted"></div>

  <hr>

  <h6 class="mb-3">Last 10 Breaks</h6>

  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Out</th>
          <th>In</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody id="logs"></tbody>
    </table>
  </div>

</div>

<script>
/* CONFIG */
const USER_NAME = "Vivek"; // change for Sapna
const API_URL = "https://script.google.com/macros/s/AKfycbwxzDHrkVACW3Yhck9AFHkLh8m2zPNghQj1vdyYwNHVG1tsv6M4SJI1GwUUpCpWYzKpzw/exec";

document.getElementById("userName").innerText = USER_NAME;

/* Digital Clock */
function updateClock(){
  const now=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
  document.getElementById("digitalClock").innerText =
    now.toLocaleTimeString("en-IN",{hour12:false});
}
setInterval(updateClock,1000); updateClock();

/* Timer */
let startPerf=0,timerInt=null;
const timerDiv=document.getElementById("timer");

function formatDuration(ms){
  const h=Math.floor(ms/3600000);
  const m=Math.floor((ms%3600000)/60000);
  const s=Math.floor((ms%60000)/1000);
  const ms2=Math.floor(ms%1000);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms2).padStart(3,'0')}`;
}

function startTimer(){
  startPerf=performance.now();
  timerDiv.style.display="block";
  timerInt=setInterval(()=>{
    timerDiv.innerText=formatDuration(performance.now()-startPerf);
  },10);
}

function stopTimer(){
  clearInterval(timerInt);
  timerDiv.style.display="none";
}

/* POST */
async function send(action){
  document.getElementById("status").innerText="Saving...";
  try{
    await fetch(API_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        name:USER_NAME,
        action,
        timestamp:new Date().toISOString()
      })
    });
    document.getElementById("status").innerText="✓ Saved";
    loadLogs();
  }catch{
    document.getElementById("status").innerText="❌ Failed";
  }
}

outBtn.onclick=()=>{
  startTimer();
  outBtn.classList.add("d-none");
  inBtn.classList.remove("d-none");
  send("out");
};

inBtn.onclick=()=>{
  stopTimer();
  inBtn.classList.add("d-none");
  outBtn.classList.remove("d-none");
  send("in");
};

/* Helpers */

function formatDate(val){
  if(!val) return "";
  const d=new Date(val);
  if(isNaN(d)) return val;
  return d.toLocaleString("en-IN",{
    day:"2-digit",month:"short",year:"numeric",
    hour:"2-digit",minute:"2-digit",second:"2-digit",
    hour12:false
  });
}

/* MAIN FIX: duration normalizer */
function normalizeDuration(val){
  if(!val) return "";

  // Already correct string from sheet
  if(typeof val === "string" && /^\d{2}:\d{2}:\d{2}\.\d{3}$/.test(val)){
    return val;
  }

  // ISO string like 1899-12-29T18:39:31.000Z
  if(typeof val === "string" && val.includes("T")){
    const d = new Date(val);
    if(!isNaN(d)){
      const totalMs =
        d.getUTCMinutes() * 60 * 1000 +
        d.getUTCSeconds() * 1000 +
        d.getUTCMilliseconds();

      return formatDuration(totalMs);
    }
  }

  return val;
}

/* JSONP logs */
function loadLogs(){
  const cb="cb_"+Math.random().toString(36).slice(2);
  const s=document.createElement("script");

  window[cb]=function(data){
    const body=document.getElementById("logs");
    body.innerHTML="";
    data.forEach(r=>{
      const dur=normalizeDuration(r[3]);
      body.innerHTML+=`
      <tr>
        <td>${formatDate(r[1])}</td>
        <td>${formatDate(r[2])}</td>
        <td><span class="badge badge-time">${dur}</span></td>
      </tr>`;
    });
    delete window[cb];
    s.remove();
  };

  s.src=`${API_URL}?action=logs&name=${USER_NAME}&callback=${cb}`;
  document.body.appendChild(s);
}

loadLogs();
</script>
</body>
</html>
