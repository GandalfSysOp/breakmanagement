<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Break Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
.card { margin-top:40px; }
#timer { font-size:1.6rem; display:none; }

/* Analog clock */
.analog-clock {
  width:200px;
  height:200px;
  border:6px solid #222;
  border-radius:50%;
  margin:15px auto;
  position:relative;
  background:white;
}

.number {
  position:absolute;
  font-weight:bold;
  transform: translate(-50%, -50%);
}

.hand {
  position:absolute;
  top:50%;
  left:50%;
  transform-origin:0% 50%;
  background:black;
}

.hour { width:35%; height:5px; }
.minute { width:45%; height:4px; }
.second { width:48%; height:2px; background:red; }
</style>
</head>
<body>

<div class="container">
<div class="row justify-content-center">
<div class="col-md-6">
<div class="card shadow">
<div class="card-body text-center">

<h3 id="userName"></h3>
<div id="digitalClock" class="text-muted"></div>

<div class="analog-clock" id="clock">
  <div class="hand hour" id="hourHand"></div>
  <div class="hand minute" id="minuteHand"></div>
  <div class="hand second" id="secondHand"></div>
</div>

<div id="timer" class="text-primary">00:00:00.000</div>

<button id="outBtn" class="btn btn-danger btn-lg px-5 mt-2">Out</button>
<button id="inBtn" class="btn btn-success btn-lg px-5 mt-2 d-none">In</button>

<div id="status" class="mt-2"></div>

<hr>
<h5>Last 10 Logs</h5>
<table class="table table-sm">
<thead>
<tr><th>Out</th><th>In</th><th>Duration</th></tr>
</thead>
<tbody id="logs"></tbody>
</table>

</div>
</div>
</div>
</div>
</div>

<script>
/* ================= CONFIG ================= */

const USER_NAME = "Vivek";   // change to Sapna on other page
const API_URL = "https://script.google.com/macros/s/AKfycbwxzDHrkVACW3Yhck9AFHkLh8m2zPNghQj1vdyYwNHVG1tsv6M4SJI1GwUUpCpWYzKpzw/exec";

/* ========================================== */

document.getElementById("userName").innerText = USER_NAME;

const outBtn = document.getElementById("outBtn");
const inBtn = document.getElementById("inBtn");
const timerDiv = document.getElementById("timer");
const statusDiv = document.getElementById("status");

/* --------- Clock numbers --------- */
const clock = document.getElementById("clock");
for (let i = 1; i <= 12; i++) {
  const n = document.createElement("div");
  n.className = "number";
  const angle = i * 30;
  const r = 85;
  n.style.left = 100 + r * Math.sin(angle * Math.PI / 180) + "px";
  n.style.top  = 100 - r * Math.cos(angle * Math.PI / 180) + "px";
  n.innerText = i;
  clock.appendChild(n);
}

/* --------- Digital + Analog Clock --------- */
function updateClock() {
  const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));

  document.getElementById("digitalClock").innerText =
    "New Delhi: " + now.toLocaleString();

  const s = now.getSeconds();
  const m = now.getMinutes();
  const h = now.getHours() % 12;

  document.getElementById("secondHand").style.transform = `rotate(${s * 6}deg)`;
  document.getElementById("minuteHand").style.transform = `rotate(${m * 6}deg)`;
  document.getElementById("hourHand").style.transform   = `rotate(${h * 30 + m / 2}deg)`;
}

setInterval(updateClock, 1000);
updateClock();

/* --------- Timer --------- */
let startPerf = 0;
let timerInterval = null;

function formatDuration(ms) {
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  const ms2 = Math.floor(ms % 1000);

  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(ms2).padStart(3,"0")}`;
}

function startTimer() {
  startPerf = performance.now();
  timerDiv.style.display = "block";
  timerInterval = setInterval(() => {
    timerDiv.innerText = formatDuration(performance.now() - startPerf);
  }, 10);
}

function stopTimer() {
  clearInterval(timerInterval);
  timerDiv.style.display = "none";
}

/* --------- POST to Sheet --------- */
async function send(action) {
  statusDiv.innerText = "Sending...";

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",   // <<< IMPORTANT
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        name: USER_NAME,
        action: action,
        timestamp: new Date().toISOString()
      })
    });

    statusDiv.innerText = "✓ Recorded";
    loadLogs();

  } catch (e) {
    statusDiv.innerText = "❌ Failed";
  }
}

/* --------- Buttons --------- */
outBtn.onclick = async () => {
  await send("out");
  outBtn.classList.add("d-none");
  inBtn.classList.remove("d-none");
  startTimer();
};

inBtn.onclick = async () => {
  await send("in");
  inBtn.classList.add("d-none");
  outBtn.classList.remove("d-none");
  stopTimer();
};

/* --------- Load logs using JSONP (no CORS) --------- */
function loadLogs() {
  const cb = "cb_" + Math.random().toString(36).substring(2);
  const script = document.createElement("script");

  window[cb] = function(data) {
    const body = document.getElementById("logs");
    body.innerHTML = "";

    data.forEach(row => {
      body.innerHTML += `
        <tr>
          <td>${row[1] || ""}</td>
          <td>${row[2] || ""}</td>
          <td>${row[3] || ""}</td>
        </tr>`;
    });

    delete window[cb];
    script.remove();
  };

  script.src = `${API_URL}?action=logs&name=${USER_NAME}&callback=${cb}`;
  document.body.appendChild(script);
}

loadLogs();

</script>
</body>
</html>
